<% content_for :page_title, @project.errors.any? ? "Error: Volunteers" : "Volunteers" %>

<%# TODO: Split this into a partial %>
<% if @project.errors.any? %>
  <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="govuk-error-summary">

    <h2 class="govuk-error-summary__title" id="error-summary-title">
      There is a problem
    </h2>

    <div class="govuk-error-summary__body">

      <ul class="govuk-list govuk-error-summary__list">

        <% @project.errors.each do |attr, msg| %>
          <% unless attr.to_s == "volunteers" %>
            <li>
              <a data-turbolinks='false' href='#project_volunteers_attributes_0_<%= "#{attr.to_s.split('.')[1]}" %>'>
                <%= msg %>
              </a>
            </li>
          <% end %>
        <% end %>

      </ul>

    </div>

  </div>
<% end %>

<span class="govuk-caption-xl">Support for your project</span>
<h1 class="govuk-heading-xl govuk-!-margin-bottom-2">Volunteers</h1>
<p class="govuk-body-l govuk-!-margin-bottom-9">Tell us what you already have in place to support your project.</p>

<section class="nlhf-summary govuk-!-margin-bottom-9">

  <header class="nlhf-summary__header">
    <h2 class="govuk-heading-m">Your project volunteers</h2>
  </header>

  <div class="nlhf-summary__body">

    <% unless @project.volunteers.first&.id.present? %>

      <h3 class="govuk-heading-m govuk-!-margin-bottom-0">You have not added any volunteers</h3>

    <% else %>

      <table class="govuk-table">

        <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          <th scope="col" class="govuk-table__header">Description</th>
          <th scope="col" class="govuk-table__header govuk-table__header--numeric">Hours</th>
        </tr>
        </thead>

        <tbody class="govuk-table__body">

        <% @project.volunteers.where.not(id: nil).each do |v| %>
          <tr class="govuk-table__row">
            <td class="govuk-table__cell"><%= v.description %></td>
            <td class="govuk-table__cell govuk-table__cell--numeric"><%= v.hours %></td>
          </tr>
        <% end %>

        </tbody>
      </table>

      <div class="nlhf-summary__total">
        <h3 class="nlhf-summary__total__title">
          <span class="nlhf-summary__total__title-text">Total hours </span>
          <span class="nlhf-summary__total__title-val"><%= calculate_volunteer_total(@project.volunteers) %></span>
        </h3>
      </div>

    <% end %>

  </div>
  <!-- /.nlhf-summary__body -->

</section>

<%= form_with model: @project, url: three_to_ten_k_project_volunteers_path, method: :put, local: true do |f| %>
  <% f.fields_for :volunteers, @project.volunteers.build do |v| %>

    <div class="nlhf-add-item govuk-!-margin-bottom-9">

      <header class="nlhf-add-item__header">
        <h2 class="govuk-heading-l">Add a volunteer</h2>
      </header>

      <div class="nlhf-add-item__body">

        <p class="govuk-body govuk-!-margin-bottom-6">Volunteers are people who give up their time for free to help deliver your project.</p>

        <div class="nlhf-add-item__row">

          <div class="govuk-character-count" data-module="govuk-character-count" data-maxwords="50">

            <div class="govuk-form-group <%= "govuk-form-group--error" if @project.errors['volunteers.description'].any? %>">

              <%= render partial: "partials/form_input_errors",
                         locals: {form_object: @project,
                                  input_field_id: :'volunteers.description'} if @project.errors['volunteers.description'].any? %>

              <%= v.label :description, class: 'govuk-label' %>
              <%= v.text_area :description,
                              required: true,
                              class: "govuk-textarea #{'govuk-textarea--error' if @project.errors['volunteers.description'].any?} govuk-js-character-count",
                              rows: 5,
                              value: "#{flash[:description] if flash[:description].present?}"
              %>
              <span id="<%= v.object_name.gsub(/[\[\]]+/, '_').chop + '_description-info' %>" class="govuk-hint govuk-character-count__message" aria-live="polite">You have 50 words remaining</span>
            </div>
          </div>
        </div>

        <div class="nlhf-add-item__row">
          <div class="govuk-form-group <%= "govuk-form-group--error" if @project.errors['volunteers.hours'].any? %>">

            <%= render partial: "partials/form_input_errors",
                       locals: {form_object: @project,
                                input_field_id: :'volunteers.hours'} if @project.errors['volunteers.hours'].any? %>

            <%= v.label :hours, class: 'govuk-label' %>
            <%= v.number_field :hours,
                               required: true,
                               min: 1,
                               class: "govuk-input govuk-input govuk-input--width-10 #{'govuk-input--error' if @project.errors['volunteers.hours'].any?}",
                               value: "#{flash[:hours] if flash[:hours].present?}"
            %>

          </div>
        </div>

        <div class="nlhf-add-item__row">
          <%= v.submit 'Add this volunteer', 'data-prevent-double-click' => true, class: 'govuk-button govuk-button--secondary'%>
        </div>

      </div>
      <!-- / nlhf-add-item__body -->
    </div>
    <!-- / nlhf-add-item -->

  <% end %>
<% end %>

<form action="<%= three_to_ten_k_project_project_support_evidence_path %>" method="get">
  <p class="govuk-body">If you have finished adding volunteers</p>
  <button data-prevent-double-click="true" class="govuk-button" data-module="govuk-button">
    Save and continue
  </button>
</form>