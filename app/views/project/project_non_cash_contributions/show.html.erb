<% content_for :page_title, @project.errors.any? ? "Error: Non-cash contributions" : "Non-cash contributions" %>

<%# TODO: Split this into a partial %>
<% if @project.errors.any? %>
  <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="govuk-error-summary">

    <h2 class="govuk-error-summary__title" id="error-summary-title">
      There is a problem
    </h2>

    <div class="govuk-error-summary__body">

      <ul class="govuk-list govuk-error-summary__list">

        <% @project.errors.each do |attr, msg| %>
          <% unless attr.to_s == "non_cash_contributions" %>
          <li>
            <a data-turbolinks='false' href='#project_non_cash_contributions_attributes_0_<%= "#{attr.to_s.split('.')[1]}" %>'>
              <%= msg %>
            </a>
          </li>
          <% end %>
        <% end %>

      </ul>

    </div>

  </div>
<% end %>

<span class="govuk-caption-xl">Support for your project</span>
<h1 class="govuk-heading-xl">Non-cash contributions</h1>

<section class="nlhf-summary nlhf-summary--non-cash govuk-!-margin-bottom-9">

  <header class="nlhf-summary__header">
    <h2 class="govuk-heading-m">Your non-cash contributions</h2>
  </header>

  <div class="nlhf-summary__body">

    <% if @project.non_cash_contributions.first.try(:id).nil? %>

      <h3 class="govuk-heading-m govuk-!-margin-bottom-0">You have not added any non-cash contributions</h3>

    <% else %>

      <%# TODO: Design for this section needed %>

      <% @project.non_cash_contributions.filter { |ncc| ncc.id.present? }.each do |ncc| %>

        <ul class="govuk-list govuk-list--bullet">

          <%= content_tag(:li, ncc.description) %>

          <ul class="govuk-list govuk-list--bullet">
            <%= content_tag(:li, "Amount:  #{number_to_currency(ncc.amount, strip_insignificant_zeros: true)}") if ncc.amount.present? %>
          </ul>

        </ul>

      <% end %>

    <% end %>

  </div>

</section>

<%= form_with model: @project, url: three_to_ten_k_project_non_cash_contributions_put_path, method: :put, local: true do |f| %>

  <%= f.fields_for :non_cash_contributions, @project.non_cash_contributions.build do |ncc| %>

    <div class="nlhf-add-item">

      <header class="nlhf-add-item__header">
        <h2 class="govuk-heading-l">Add a non-cash contribution</h2>
      </header>

      <div class="nlhf-add-item__body">

        <details class="govuk-details" data-module="govuk-details">

          <summary class="govuk-details__summary">

          <span class="govuk-details__summary-text">
            What are non-cash contributions?
          </span>

          </summary>

          <div class="govuk-details__text">

            <p class="govuk-body">
              Non-cash contributions are things you need for your project that you do not have to pay for.
            </p>

            <p class="govuk-body">
              For example - the use of a room in a local business, or materials being donated by a local firm.
            </p>

          </div>

        </details>

        <div class="nlhf-add-item__row">

          <div class="govuk-character-count" data-module="govuk-character-count" data-maxwords="50">

            <div class="govuk-form-group <%= "govuk-form-group--error" if @project.errors['non_cash_contributions.description'].any? %>">

              <%= render partial: "partials/form_input_errors",
                         locals: {form_object: @project,
                                  input_field_id: :'non_cash_contributions.description'} if @project.errors['non_cash_contributions.description'].any? %>

              <%= ncc.label :description, 'Description', class: 'govuk-label' %>
              <%= ncc.text_area :description,
                                rows: 5,
                                class: 'govuk-textarea govuk-js-character-count',
                                "aria-describedby" => "project_non_cash_contributions_attributes_0_description-info",
                                value: "#{flash[:description] if flash[:description].present?}"
              %>

            </div>

            <span class="govuk-hint govuk-character-count__message"
                  id="project_non_cash_contributions_attributes_0_description-info"></span>

          </div>

        </div>

        <div class="nlhf-add-item__row">

          <div class="govuk-form-group <%= "govuk-form-group--error" if @project.errors['non_cash_contributions.amount'].any? %>">

            <%= render partial: "partials/form_input_errors",
                       locals: {form_object: @project,
                                input_field_id: :'non_cash_contributions.amount'} if @project.errors['non_cash_contributions.amount'].any? %>

            <%= ncc.label :amount, "Estimated value", class: 'govuk-label' %>

            <span id="project_non_cash_contributions_attributes_0_amount-hint" class="govuk-hint govuk-!-font-size-17">
              An estimate of how much this would have cost if your project had to pay for it
            </span>

            <div class="nlhf-currency-denote">

              <div class="nlhf-currency-denote__symbol">
                &pound;
              </div>

              <div class="nlhf-currency-denote__capture">

                <%= ncc.number_field :amount,
                                     min: 1,
                                     class: 'govuk-input',
                                     "autocomplete" => "off",
                                     value: "#{flash[:amount] if flash[:amount].present?}"
                %>

              </div>

            </div>

          </div>

        </div>

        <div class="nlhf-add-item__row">

          <%= ncc.submit 'Add non-cash contribution',
                         role: "button",
                         'data-prevent-double-click' => 'true',
                         class: 'govuk-button govuk-button--secondary'
          %>

        </div>

      </div>

    </div>

  <% end %>

<% end %>

<hr class="govuk-section-break--l govuk-section-break--visible">

<p class="govuk-body">If you have finished adding all your non-cash contributions</p>

<a href="<%= "#{three_to_ten_k_project_volunteers_url}" %>" role="button" draggable="false" class="govuk-button"
   data-module="govuk-button" aria-label="Continue button">
  Save and continue
</a>