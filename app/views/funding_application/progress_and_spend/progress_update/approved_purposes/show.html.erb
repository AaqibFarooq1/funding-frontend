<%=
  render partial: "partials/page_title",
         locals: {
            model_object: @funding_application,
            page_title: t('progress_and_spend.progress_update.approved_purposes.page_title')
         }
%>

<% # errors generated on this page do not carry information on where in the page %>
<% # the affected attribute is rendered.  Thus working href can't be created. %>
<% # Consider an approach that loops through field for attributes. %>
<%=
  render(
      partial: 'partials/summary_errors',
      locals: {
        form_object:
          @funding_application.arrears_journey_tracker.progress_update,
          first_form_element: :entering_update
      }
    ) if @funding_application.arrears_journey_tracker.progress_update.errors.any?
%>


<fieldset class="govuk-fieldset">
  <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">

		<span class="govuk-caption-xl govuk-!-padding-bottom-2">
			<%= t('progress_and_spend.progress_update.approved_purposes.page_caption')%>
		</span>

		<h1 class="govuk-heading-l">
			<%= t('progress_and_spend.progress_update.approved_purposes.page_heading')%>
		</h1>

	</legend>

  <%=
    form_with model: @funding_application.arrears_journey_tracker.progress_update,
    url: funding_application_progress_and_spend_progress_update_approved_purposes_path(),
    method: :post,
    local: true do |form|
  %>

    <div class="govuk-form-group <%= "govuk-form-group--error" if @funding_application.arrears_journey_tracker.errors.any? %>">

      <p class="govuk-body govuk-hint govuk-!-padding-bottom-4">
        <%= t('progress_and_spend.progress_update.approved_purposes.page_hint') %>
      </p>

      <%=
        render(
          partial: 'partials/form_group_errors',
          locals: {
            form_object: @funding_application.arrears_journey_tracker.progress_update
          }
        ) if @funding_application.arrears_journey_tracker.progress_update.errors.any?
      %>


      <%=
        form.fields_for :progress_update_approved_purpose, @funding_application.arrears_journey_tracker.progress_update.progress_update_approved_purpose do |ap|
      %>

        <div class="govuk-checkboxes" data-module="govuk-checkboxes">

          <div class="govuk-checkboxes__item  govuk-!-margin-bottom-4">

            <%=
              ap.check_box :entering_update,
              {
                class: "govuk-checkboxes__input",
                'data-aria-controls' => 'conditional-description-conditional'
              },
              'true',
              'false'
            %>

            <%=
              ap.label :entering_update,
              ap.object.description,
              class: "govuk-label govuk-checkboxes__label"
            %>

          </div>

          <div class="govuk-checkboxes__conditional govuk-checkboxes__conditional--hidden"
            id="conditional-description-conditional">

            <div class="govuk-character-count" data-module="govuk-character-count"
              data-maxwords="300">

              <div class="govuk-form-group">
                <%=
                  ap.label :progress,
                  t('buttons.labels.update'),
                  class: "govuk-label govuk-!-padding-left-2"
                %>

                <%=
                  ap.text_area :progress,
                  rows: 5,
                  class: "govuk-textarea  #{'govuk-js-character-count' if I18n.locale == :"en-GB"} " \
                    "#{'govuk-input--error' if ap.object.errors.any?}",
                  'aria-describedby' => "#{ap.object_name.parameterize.underscore}_progress-info"
                %>

                <span id= <%="#{ap.object_name.parameterize.underscore}_progress-info"%>
                  class="govuk-hint govuk-character-count__message" aria-live="polite">
                  <%= t('generic.word_count', max_words:300) %>
                </span>

              </div>

            </div>

          </div>

        </div>

      <% end %>

      <div class="govuk-checkboxes" data-module="govuk-checkboxes">

        <div class="govuk-checkboxes__item  govuk-!-margin-bottom-4">

            <%=
              form.check_box :no_progress_update,
              {
                class: "govuk-checkboxes__input"
              },
              'true',
              'false'
            %>

            <%=
              form.label t('progress_and_spend.progress_update.approved_purposes.no_update_yet'),
              class: "govuk-label govuk-checkboxes__label"
            %>

        </div>

      </div>

    </div>

    <%= render(
        ButtonComponent.new(
          element: "button",
          text: t("buttons.labels.save_and_continue")
        )
      )
    %>

  <% end %>

</fieldset>
